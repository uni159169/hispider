<html>
    <head>
        <title>Hitask Monitor</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
            body{margin:0px;}
            #treebody{position:absolute;background-color:#ffffff;
                border:1px solid #81BEF7;left:10px;top:10px;}
            .formdiv{position:absolute;width:200px;background-color:#ffffff;
                border:1px solid #81BEF7;padding:10px;overflow:auto;display:none;}
            .formclose{font-size:14pt;font-weight:100;color:silver;cursor:pointer;display:inline;}
            .treeline{border:0px;font-size:12pt;font-weight:bold;color:#BDBDBD;}
            .title{border:0px;font-size:12pt;background-color:#ffffff;color:#000000;}
            .btitle{border:0px;font-size:12pt;background-color:#F2F2F2;}
            .node
            {
                overflow:hidden;
                color:black;
                font-size:12pt;
            }
            .editor
            {
                color:blue;
                font-size:13pt;
                font-weight:bolder;
                cursor:pointer;
            }
            .icon
            {
                display:inline;
                color:#A4A4A4;
                font-size:12pt;
                text-align:center;
                cursor:pointer;
            }
            .nchilds
            {
                display:inline;
                color:red;
                font-size:12pt;
            }

        </style>
        <script language='javascript'>
            function trim(str)
            {
                return str.replace(/(^\s+|\s+$)/, "");
            }
            function highlight(obj)
            {
                obj.className = "btitle";
            }
            function backcss(obj)
            {
                obj.className = "title";
            }
            function CreateXMLHTTP()
            {
                var xmlhttp = null;
                try{
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                    as = 1;
                    }catch(e){
                    try{
                        xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
                        as = 1;
                        }catch(e){
                        try{
                            xmlhttp = new XMLHttpRequest();
                            as = 2;
                            }catch(e){
                            xmlhttp = null;
                            as = 0;
                        }
                    }
                }
                return xmlhttp;
            }
            function AddNode(pid, id, name, count)
            {
                if(document.getElementById("node"+id) != null) return;
                //alert("pid:"+pid+"id:"+id+"name:"+name);
                var oParent = null;
                if(pid >= 0)
                {
                    oParent = document.getElementById("node"+pid);
                }
                else
                {
                    oParent = document.getElementById('treebody');
                }
                if(oParent == null) return;
                var oNode = document.createElement('div');
                var level = oParent.getAttribute('level') * 1;
                var nchilds = oParent.getAttribute('nchilds') * 1;
                oParent.setAttribute('nchilds', nchilds + 1);
                var ofold = null;
                if(nchilds == 0 && (ofold = document.getElementById('fold_'+pid)))
                {
                    ofold.innerHTML = '▼';
                }
                var onchilds = null;
                if((onchilds = document.getElementById('ch_'+pid)))
                {
                    onchilds.innerHTML = nchilds+1;
                }
                oNode.id = "node" + id;
                oNode.className = 'node';
                oNode.setAttribute('level', level + 1);
                oNode.setAttribute('nchilds', count);
                oNode.setAttribute('parent', pid);
                oNode.setAttribute('UID', id);
                oNode.setAttribute('UName', name);
                htmlstr = "<div id='title_"+ id +"' class='title' ";
                htmlstr += " onmousemove='highlight(this);' onmouseout='backcss(this);'>";
                htmlstr += "<span class='treeline'>";
                var i = 0;
                for(i = 0; i < (level-1); i++)
                {
                    htmlstr += "&nbsp;&nbsp;&nbsp;";
                    htmlstr += "┊";
                }
                if(level > 0)
                {
                    htmlstr += "&nbsp;&nbsp;&nbsp;";
                }
                htmlstr += "</span>";
                if(count > 0)
                    htmlstr += "<span id='fold_"+ id +"' class='icon' onclick='Fold(this)'>✚</span>";
                else
                    htmlstr += "<span id='fold_"+ id +"' class='icon' onclick='Fold(this)'>►</span>";
                htmlstr += "&nbsp;&nbsp;";
                htmlstr += "<span id='nd_"+id+"' class='nd_name'>"+name+"</span>";
                htmlstr += "[<span id='ch_"+ id +"' class='nchilds' >"+count+"</span>]";
                htmlstr += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                htmlstr += "<span class='editor' title='Add' ";
                htmlstr += "onclick='XAdd(event)'>✚</span>";
                htmlstr += "&nbsp;&nbsp;&nbsp;&nbsp;";
                htmlstr += "<span class='editor' title='Delete' ";
                htmlstr += "onclick='XDelete("+id+")'>✘</span>";
                htmlstr += "&nbsp;&nbsp;&nbsp;&nbsp;";
                htmlstr += "<span class='editor' title='Rename' ";
                htmlstr += "onclick='XEdit(event)'>✎</span>";
                htmlstr += "&nbsp;&nbsp;&nbsp;&nbsp;";
                htmlstr += "</div>\r\n";
                oNode.innerHTML = htmlstr; 
                oParent.appendChild(oNode);
            }
            function UpdateNode(id, name)
            {
                var oNode = document.getElementById('node'+id);
                if(oNode != null)
                {
                    oNode.setAttribute('UName', name);
                    var oName = document.getElementById('nd_'+id);
                    if(oName != null)
                    {
                        oName.innerHTML = name;
                    }
                }
            }
            function ListChilds(pid, url, argv)
            {
                var xmlHttp = CreateXMLHTTP();
                if(xmlHttp != null)
                {
                    xmlHttp.open('POST', url, true);
                    xmlHttp.setRequestHeader("Content-Length", argv.length);
                    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xmlHttp.onreadystatechange=function()
                    {
                        if(xmlHttp.readyState==4)
                        {
                            if(xmlHttp.status == 200)
                            {
                                var tnode = eval(xmlHttp.responseText);
                                if(tnode['id'] == pid)
                                {
                                    var i = 0;
                                    for(i = 0; i < tnode['nchilds']; i++)
                                    {
                                        AddNode(pid, tnode['childs'][i]['id'] * 1, 
                                        tnode['childs'][i]['name'], 
                                        tnode['childs'][i]['nchilds']);
                                    }
                                }
                            }
                        }
                    }
                    xmlHttp.send(argv);
                }
            }
            //close form
            function CloseForm(element)
            {
                element.parentNode.parentNode.style.display = "none";
            }

            //Add child
            function XAdd(e)
            {
                e = e || window.event;
                var element = e.target || e.srcElement;
                var form = document.forms["editorform"];
                form['op'].value = 'node_add';
                form['nodeid'].value = '';
                form['nodename'].value = '';
                form['pid'].value = element.parentNode.parentNode.getAttribute('UID');
                var Xdiv =  document.getElementById("txtform");
                var x = e.clientX;
                var y = e.clientY;
                Xdiv.style.left = x - 50;
                Xdiv.style.top = y + 10;
                Xdiv.style.display = 'inline';
            }
            function XEdit(e)
            {
                e = e || window.event;
                var element = e.target || e.srcElement;
                var form = document.forms["editorform"];
                form['op'].value = 'node_update';
                form['pid'].value = '';
                form['nodeid'].value = element.parentNode.parentNode.getAttribute('UID');
                form['nodename'].value = element.parentNode.parentNode.getAttribute('UName');
                var Xdiv =  document.getElementById("txtform");
                var x = e.clientX;
                var y = e.clientY;
                Xdiv.style.left = x - 50;
                Xdiv.style.top = y + 10;
                Xdiv.style.display = 'inline';
            }
            function EditNode(form)
            {
                var argv = "";
                var op = form['op'].value;
                var pid = form['pid'].value;
                var nodeid = form['nodeid'].value;
                var nodename = form['nodename'].value;
                if(op == 'node_add' && nodename && pid >= 0)
                {
                    argv = "op="+op+"&name="+nodename+"&parentid="+pid;
                }
                else if(op == 'node_update' && nodename && nodeid > 0)
                {
                    argv = "op="+op+"&name="+nodename+"&nodeid="+nodeid;
                }
                else return ;
                //alert("op:"+op+"nodeid:"+nodeid+"pid:"+pid+"nodename:"+nodename);
                var xmlHttp = CreateXMLHTTP();
                if(xmlHttp != null)
                {
                    xmlHttp.open('POST', '/', true);
                    xmlHttp.setRequestHeader("Content-Length", argv.length);
                    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xmlHttp.onreadystatechange=function()
                    {
                        if(xmlHttp.readyState==4)
                        {
                            if(xmlHttp.status == 200)
                            {
                                var id = trim(xmlHttp.responseText);
                                if(op == 'node_add' && id  > 0)
                                {
                                    AddNode(pid, id, nodename, 0);
                                }
                                else if(op == 'node_update' && id > 0 && id == nodeid)
                                {
                                    UpdateNode(id, nodename);
                                }
                            }
                            
                        }
                    }
                    xmlHttp.send(argv);
                }
                var div = document.getElementById('txtform');
                div.style.display = 'none';
                return true;
            }
            //delete node
            function XDelete(nodeid)
            {
                var xmlHttp = null;
                var oNode = document.getElementById("node"+nodeid);
                var name = null;
                if(nodeid > 0 && oNode != null && (name = oNode.getAttribute('UName'))
                    && confirm('Really delete node:'+nodeid+' name:'+name+' ?') 
                    && (xmlHttp = CreateXMLHTTP()) != null)
                {
                    var argv = "op=node_delete&nodeid="+nodeid;
                    xmlHttp.open('POST', '/', true);
                    xmlHttp.setRequestHeader("Content-Length", argv.length);
                    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xmlHttp.onreadystatechange=function()
                    {
                        if(xmlHttp.readyState==4)
                        {
                            if(xmlHttp.status == 200)
                            {
                                var id = trim(xmlHttp.responseText);
                                if(id == nodeid)
                                {
                                    oNode.innerHTML = ""; 
                                }
                            }
                            
                        }
                    }
                    xmlHttp.send(argv);
                }
            }
            //fold node
            function Fold(element)
            {
                var nchilds = element.parentNode.parentNode.getAttribute('nchilds') * 1;
                var uid = element.parentNode.parentNode.getAttribute('UID') * 1;
                var url = "/";
                var argv = "op=node_childs&nodeid="+uid;
                if(element.innerHTML == '✚')
                {
                    element.parentNode.parentNode.style.height = '';
                    if(nchilds > 0)element.innerHTML = '▼';
                    ListChilds(uid, url, argv);
                }
                else if(element.innerHTML == '►')
                {
                    ListChilds(uid, url, argv);
                }
                else
                {
                    element.parentNode.parentNode.style.height = element.parentNode.offsetHeight;
                    if(nchilds > 0) element.innerHTML = '✚';
                }
            }
        </script>
    </head>
    <body>
    <div id='treebody' level='0'></div>
    <div id='txtform' class='formdiv'>
        <form name="editorform" action="javascript:void(0)" onsubmit="return EditNode(this);"> 
            <input type=hidden name='op' value='node_add' >
            <input type=hidden name='nodeid' value='0' >
            <input type=hidden name='pid' value='0' >
            <input type='text' name='nodename' class='txtinput' size=16>
            <input type=submit value='ok' class='submit' >
            &nbsp;&nbsp;<span class='formclose' onclick="CloseForm(this)">x</span>
        </form>
    </div>
    <script language='javascript'>
    AddNode(-1,0,"Root",0);
    /*
    var levels = 0;
    function addnodes(pid)
    {
        var i = 0, id = 0;
        for(i = 1; i < 10; i++)
        {
            id = pid * 10 + i;
            AddNode(pid, id, "node"+id);
        }
    }
    addnodes(0);
    */
    /*
    alert(document.getElementById('treebody').innerHTML);
    document.write("<pre>");
    document.write(dxtree.TreeList);
    document.write("</pre>");
    */
</script>
</body>
</html>
